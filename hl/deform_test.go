package hl

import (
	"testing"
	"github.com/franela/goblin"
	"simplex/geom"
	"simplex/constdp/ln"
	"simplex/constdp/rng"
	"fmt"
	"strings"
	"simplex/constdp/opts"
	"time"
)

func TestDeform(t *testing.T) {
	g := goblin.Goblin(t)
	var lnwkts = []testD{
		{21, false,
		 "LINESTRING ( 810 540, 790 570, 800 580, 820 580, 860 570, 880 600, 870 610, 850 610, 800 610, 810 650, 890 640, 900 640, 920 600, 930 580, 930 540, 920 500, 880 490, 860 520, 810 510, 750 520, 780 460, 730 410, 830 440, 890 410, 940 450, 970 500, 1040 510, 1050 570, 1080 620, 1040 660, 1020 720, 950 720, 840 680, 760 690, 690 720, 710 640, 630 620 )"},
		{4, true,
		 "LINESTRING (330.5770802442433 581.2490753170464, 289.3831572774428 587.7108671549759, 256.2664741080541 582.8645232765288, 197.441310580554 568.7784526288414, 194.9264255896295 552.0343728591217, 202.11368678741684 562.5981327919068, 211.82048369391282 548.4791554733671, 216.23266410595645 527.5948348563605, 218.58582699237974 516.711456506653, 185.64154658245394 504.3573513529308, 176.52304039756376 493.17982764242026, 172.1108599855201 481.4140132103039, 172.69915070712594 461.706274036509, 157.69773730617757 464.3535822837352, 137.9899981323827 464.941873005341)"},
		{4, true,
		 "LINESTRING ( 330.5770802442433 581.2490753170464, 289.3831572774428 587.7108671549759, 256.2664741080541 582.8645232765288, 197.441310580554 568.7784526288414, 194.9264255896295 552.0343728591217, 202.11368678741684 562.5981327919068, 211.74199479333123 560.2115030178386, 227.0827680621383 567.7253511494993, 236.3364918395976 564.4237400821951, 249.31123545163425 568.9776591714426, 241.34572392737135 584.7737454387759, 235.22277020477063 586.8230484841366, 227.70892207311002 596.8415126596841, 222.69968998533628 614.3738249668921, 180 620 )"},
		{4, true,
		 "LINESTRING ( 330.5770802442433 581.2490753170464, 289.3831572774428 587.7108671549759, 256.2664741080541 582.8645232765288, 197.441310580554 568.7784526288414, 194.9264255896295 552.0343728591217, 185.35048559505015 556.3488518933807, 195.5654156879096 545.0472271097915, 227.0827680621383 567.7253511494993, 236.3364918395976 564.4237400821951, 237.11918435331225 572.5637422248274, 241.34572392737135 584.7737454387759, 209.2553308650708 583.2083604113466, 207.2203303294127 590.2525930347784, 204.40263728003995 601.9929807404982, 189.2184025139758 610.2895213858734 )"},
		{4, false,
		 "LINESTRING ( 230.0195128864249 579.5695574923628, 217.3543939499459 574.8349335908753, 210.8442860854006 568.916653714016, 197.441310580554 568.7784526288414, 194.9264255896295 552.0343728591217, 180 560, 190.34928117240688 543.9605324190618, 210 550, 236.3364918395976 564.4237400821951, 237.11918435331225 572.5637422248274, 241.34572392737135 584.7737454387759, 209.2553308650708 583.2083604113466, 207.2203303294127 590.2525930347784, 204.40263728003995 601.9929807404982, 189.2184025139758 610.2895213858734 )"},
		{7, false,
		 "LINESTRING ( 208 576, 212 568, 206 572, 208 562, 202 568, 196 564, 200 560, 194 554, 202 556, 214 556, 220 560, 220 568, 226 572, 220 580, 212 584, 210 590, 204 586, 200 596, 192 588, 196 588, 202 582 )"},
		{7, false,
		 "LINESTRING ( 208 576, 212 568, 206 572, 208 562, 202 568, 196 564, 200 560, 194 554, 202 556, 214 556, 220 560, 220 568, 226 572, 220 580, 212 584, 210 590, 208 584, 204 588, 202 582, 204 584, 208 580 )"},
	}
	g.Describe("hull deformation", func() {
		options := &opts.Opts{
			Threshold:              50.0,
			MinDist:                20.0,
			RelaxDist:              30.0,
			KeepSelfIntersects:     true,
			AvoidNewSelfIntersects: true,
			GeomRelation:           true,
			DistRelation:           false,
			DirRelation:            false,
		}
		g.It("should test selection of hulls for deformation", func() {
			g.Timeout(60*time.Minute)
			for _, o := range lnwkts[:1] {
				k, _, wkt := o.k, o.bln, o.wkt
				coords := geom.NewLineStringFromWKT(wkt).Coordinates()
				pln := ln.NewPolyline(coords)
				n := len(coords) - 1
				fmt.Println(wkt)
				ha, hb := NewHullNode(pln, rng.NewRange(0, k), rng.NewRange(0, n)), NewHullNode(pln, rng.NewRange(k, n), rng.NewRange(0, n))
				fmt.Println(hb.Geom.WKT())
				fmt.Println(ha.Geom.WKT())

				slns := select_hulls_to_deform(ha, hb, options)
				g.Assert(len(slns)).Equal(1)

				fmt.Println(strings.Repeat("--", 80))
			}


		})
	})
}
